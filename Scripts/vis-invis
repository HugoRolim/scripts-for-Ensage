-- Made by Staskkk.

require("libs.Utils")

-- config
hotkey = string.byte("G") -- hotkey for activate/deactivate control invisible
xx = 254 -- x parameter of left-top corner of top bar heroes of your team.
yy = 5 -- y parameter of left-top corner of top bar heroes of your team.
ww = 59 -- width of heroes icons.
hh = 32 -- height of heroes icons.
centwidth = 181 -- distance between icons of heroes of different teams.
visiblebyenemy = true
enemyinvisible = true

-- code
sleeptick = {0,0}
panel = {}
init = false
rot = true
pos = 0
index = 1
active = true
angle = 0
activated = false

function Key(msg,code)
	if client.console or client.chat or not init then return end
	if msg == KEY_UP and code == hotkey then
		activated = not activated
	end
end

function Tick(tick)
	if not client.connected or client.loading or client.console or not entityList:GetMyHero() then
		return
	end
	if not init then
		mp = entityList:GetMyPlayer()
		init = true
	end
	if not couriers or #couriers == 0 then
		couriers = entityList:GetEntities({type=LuaEntity.TYPE_COURIER, team = mp.team, alive=true})
		if #couriers ~= 0 then
			pos = couriers[1].position
		end
	end
	if sleeptick[1] < tick then
		sleeptick[1] = tick + 200
		local heroes = entityList:GetEntities({type=LuaEntity.TYPE_HERO, illusion = false})
		for i,v in ipairs(heroes) do
			if not panel[v.handle] then
				if v.team == 3 then
					selftop = centwidth
				else
					selftop = 0
				end
				panel[v.handle] = drawMgr:CreateRect(xx+v.playerId*ww+selftop,yy,ww,hh,0x5050ffff,true)
				panel[v.handle].visible = true
			end
			if panel[v.handle].outline then
				if not v.visible or not v.alive then
					panel[v.handle].color = 0x808080ff
				else
					panel[v.handle].color = 0x5050ffff
				end
			end

			if v.team == mp.team then
				if visiblebyenemy then
					if v.alive and v.visibleToEnemy then
						if panel[v.handle].outline then
							panel[v.handle].color = 0x5050ff88
							panel[v.handle].outline = false
						end
					elseif not panel[v.handle].outline then
						panel[v.handle].color = 0x5050ffff
						panel[v.handle].outline = true
					end
				end
			end
		end
	end

	if enemyinvisible and activated and sleeptick[2] < tick and #couriers > 0 then
		local enem = entityList:FindEntities({type = LuaEntity.TYPE_HERO, team = 5-mp.team, alive = true, illusion = false})
		if not enemies or #enem ~= #enemies then
			enemies = enem
		end
		if #enemies > 0 then
			sleeptick[2] = tick + 800
			if not active and couriers[1].activity == LuaEntityNPC.ACTIVITY_IDLE then
				active = true
			end
			if active and pos ~= couriers[1].position then
				active = false
			end
			pos = couriers[1].position
			if active then
				if rot then
					index = index + 1
					if index > #enemies then 
						index = 1
					end
					angle = couriers[1].rotR
					couriers[1]:Follow(enemies[index])
					couriers[1]:Stop()
					rot = false
				elseif angle ~= couriers[1].rotR then
					if not panel[enemies[index].handle].outline then
						panel[enemies[index].handle].outline = true
					end
					couriers[1]:Move(Vector( couriers[1].position.x-100, couriers[1].position.y-100, couriers[1].position.z))
					couriers[1]:Stop()
					rot = true
				else
					if panel[enemies[index].handle].outline then
						panel[enemies[index].handle].color = 0x80808088
						panel[enemies[index].handle].outline = false
					end
					rot = true
				end
			end
		end
	end
end

function Close()
	panel = {}
	init = false
	rot = false
	angle = 0
	collectgarbage("collect")
end

script:RegisterEvent(EVENT_KEY,Key)
script:RegisterEvent(EVENT_TICK,Tick)
script:RegisterEvent(EVENT_CLOSE,Close)
